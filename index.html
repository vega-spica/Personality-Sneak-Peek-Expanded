
<head>
    <link rel="stylesheet" href="./css/style.css" type="text/css">
    <link rel="shortcut icon" type="image/png" href="./res/img/favicon.png">
    <title> Personality Sneak-Peek (Expanded) </title>
    <script src="./js/common.js"></script>
    <script src="./js/spineObject.js"></script>
    <script src="./dict/dragondict.js"></script>
    <script src="./dict/personalitydict.js"></script>
    <script src="./dict/myownfrontdict.js"></script>
    <script src="./dict/myownbackdict.js"></script>
    <script src="./dict/myheartfrontdict.js"></script>
    <script src="./dict/myheartbackdict.js"></script>
    <script src="./dict/cavebgdict.js"></script>
    <script src="./dict/cavefloordict.js"></script>
    <script src="https://unpkg.com/@esotericsoftware/spine-webgl@4.1.*/dist/iife/spine-webgl.js"></script>
    <script>
        window.onload = init;

    // Cache all Spine Canvases instances here so can dispose later
    var canvases = {
        backAura: null,
        frontAura: null,
        dragon: null,
        background: null,
        floor: null
    };

        var species;
        var personality;
        var gender = "m";
        var form;
        //the species name here must be manually set to the first dragon in the list.
            // or else bad stuff happens.
        var speciesName = "dummydragon";
        var formNumber = "01";
        var animState = "idle";
        var maleButton;
        var femaleButton;
        var neutralButton;
        var maleLabel;
        var femaleLabel;
        var neutralLabel;
        var speciesDisplay;
        var formDisplay;
        var stage = "adult";
        var myownfront;
        var myownfrontcolour;
        var myownback;
        var myownbackcolour;
        var myheartfront;
        var myheartfrontcolour;
        var myheartback;
        var myheartbackcolour;
        var customfront;
        var customfrontcolour;
        var customback;
        var custombackcolour;
        var personalityName;
        var cavebg;
        var cavefloor;
        var bgSelection;
        var floorSelection;
        var bgState = "idle";
        var floorState = "idle";
        
        function init() {
            //hey, wanna see a cool trick?
                //https://vega-spica.github.io/Personality-Sneak-Peek-Expanded?species=chaosjanerr
                    //now you're forced to see Gerner!
            var speciesParam = new URLSearchParams(location.search).get('species');
            speciesName = speciesParam === null ? speciesName : speciesParam;

            //and now i can force you to see Gerner with a matching aura it can never have.
                //https://vega-spica.github.io/Personality-Sneak-Peek-Expanded/?species=chaosjanerr&personality=Baleful
                    //sad times.
            var personalityParam = new URLSearchParams(location.search).get('personality');
            personalityName = personalityParam === null ? personalityName : personalityParam;

            var formParam = new URLSearchParams(location.search).get('form');
            formNumber = formParam === null ? formNumber : formParam;

            var stageParam = new URLSearchParams(location.search).get('stage');
            stage = stageParam === null ? stage : stageParam;

            var frontParam = new URLSearchParams(location.search).get('front');
            customfront = frontParam === null ? "[None]" : frontParam;

            var backParam = new URLSearchParams(location.search).get('back');
            customback = backParam === null ? "[None]" : backParam;

            var frontColourParam = new URLSearchParams(location.search).get('frontcolour');
            customfrontcolour = frontColourParam === null ? "Black" : frontColourParam;

            var backColourParam = new URLSearchParams(location.search).get('backcolour');
            custombackcolour = backColourParam === null ? "Black" : backColourParam;

            var bgParam = new URLSearchParams(location.search).get('bg');
            bgSelection = bgParam === null ? cavebg : bgParam;

            var floorParam = new URLSearchParams(location.search).get('floor');
            floorSelection = floorParam === null ? cavefloor : floorParam;
            
            //get list of species
            var speciesKeys = Object.keys(speciesJson);
            
            //get a list of personalities
            var personalityKeys = Object.keys(personalityJson);

            //get a list of custom fronts
            var myownfrontKeys = Object.keys(myownfrontJson);
            var myheartfrontKeys = Object.keys(myheartfrontJson);

            //get a list of custom backs
            var myownbackKeys = Object.keys(myownbackJson);
            var myheartbackKeys = Object.keys(myheartbackJson);

            //get a list of backgrounds
            var cavebgKeys = Object.keys(cavebgJson);

            //get a list of floors
            var cavefloorKeys = Object.keys(cavefloorJson);
            
            // assign the appearance control elements to the global variables
            species = document.getElementById("species");
            personality = document.getElementById("personality");
            form = document.getElementById("form");
            maleButton = document.getElementById("male");
            maleLabel = document.getElementById("maleLabel");
            femaleButton = document.getElementById("female");
            femaleLabel = document.getElementById("femaleLabel");
            neutralButton = document.getElementById("neutral");
            neutralLabel = document.getElementById("neutralLabel");
            hatchButton = document.getElementById("hatch");
            hatchLabel = document.getElementById("hatchLabel");
            hatchlingButton = document.getElementById("hatchling");
            hatchlingLabel = document.getElementById("hatchlingLabel");
            adultButton = document.getElementById("adult");
            adultLabel = document.getElementById("adultLabel");
            essenceButton = document.getElementById("essence");
            essenceLabel = document.getElementById("essenceLabel");
            prismButton = document.getElementById("prism");
            prismLabel = document.getElementById("prismLabel");
            myownfront = document.getElementById("myownfront");
            myownfrontcolour = document.getElementById("myownfrontcolour");
            myownback = document.getElementById("myownback");
            myownbackcolour = document.getElementById("myownbackcolour");
            myheartfront = document.getElementById("myheartfront");
            myheartfrontcolour = document.getElementById("myheartfrontcolour");
            myheartback = document.getElementById("myheartback");
            myheartbackcolour = document.getElementById("myheartbackcolour");
            cavebg = document.getElementById("cavebg");
            cavefloor = document.getElementById("cavefloor");
            
            //create option tags for Species
            var speciesOption;
            for (var i = 0; i < speciesKeys.length; i++){
                speciesOption = document.createElement("option");
                speciesOption.innerText = speciesJson[speciesKeys[i]].speciesDisplay;
                speciesOption.value = speciesKeys[i];
                species.appendChild(speciesOption);
            };
            species.value = speciesName;
            
            //create option tags for Personalities
            var personalityOption;
            for (var i = 0; i < personalityKeys.length; i++){
                personalityOption = document.createElement("option");
                personalityOption.innerText = personalityKeys[i];
                personalityOption.value = personalityKeys[i];
                personality.appendChild(personalityOption);
            };
            if (personalityName) {
                personality.value = personalityName;
            }
            
            
            //create option tags for Forms
            var formKeys = Object.keys(speciesJson[speciesName].stage["adult"].forms);
            formKeys = formKeys.sort();
            for (var i = 0; i < formKeys.length; i++){
                formOption = document.createElement("option");
                formOption.innerText = speciesJson[speciesName].stage["adult"].forms[formKeys[i]].formDisplay;
                formOption.value = formKeys[i];
                form.appendChild(formOption);
            };
            if (formNumber){
                form.value = formNumber;
            }

            //create option tags for custom Fronts
            var myownfrontOption;
            for (var i = 0; i < myownfrontKeys.length; i++) {
                myownfrontOption = document.createElement("option");
                myownfrontOption.innerText = myownfrontKeys[i];
                myownfrontOption.value = myownfrontKeys[i];
                myownfront.appendChild(myownfrontOption);
            };

            var myheartfrontOption;
            for (var i = 0; i < myheartfrontKeys.length; i++) {
                myheartfrontOption = document.createElement("option");
                myheartfrontOption.innerText = myheartfrontKeys[i];
                myheartfrontOption.value = myheartfrontKeys[i];
                myheartfront.appendChild(myheartfrontOption);
            };

            //create option tags for custom Front Colours
            var myownfrontcolourKeys = Object.keys(myownfrontJson["[None]"]);
            for (var i = 0; i < myownfrontcolourKeys.length; i++) {
                myownfrontcolourOption = document.createElement("option");
                myownfrontcolourOption.innerText = myownfrontcolourKeys[i];
                myownfrontcolourOption.value = myownfrontcolourKeys[i];
                myownfrontcolour.appendChild(myownfrontcolourOption);
            };

            var myheartfrontcolourKeys = Object.keys(myheartfrontJson["[None]"]);
            for (var i = 0; i < myheartfrontcolourKeys.length; i++) {
                myheartfrontcolourOption = document.createElement("option");
                myheartfrontcolourOption.innerText = myheartfrontcolourKeys[i];
                myheartfrontcolourOption.value = myheartfrontcolourKeys[i];
                myheartfrontcolour.appendChild(myheartfrontcolourOption);
            };

            //create option tags for custom Backs
            var myownbackOption;
            for (var i = 0; i < myownbackKeys.length; i++) {
                myownbackOption = document.createElement("option");
                myownbackOption.innerText = myownbackKeys[i];
                myownbackOption.value = myownbackKeys[i];
                myownback.appendChild(myownbackOption);
            };

            var myheartbackOption;
            for (var i = 0; i < myheartbackKeys.length; i++) {
                myheartbackOption = document.createElement("option");
                myheartbackOption.innerText = myheartbackKeys[i];
                myheartbackOption.value = myheartbackKeys[i];
                myheartback.appendChild(myheartbackOption);
            };

            //create option tags for custom Back Colours
            var myownbackcolourKeys = Object.keys(myownbackJson["[None]"]);
            for (var i = 0; i < myownbackcolourKeys.length; i++) {
                myownbackcolourOption = document.createElement("option");
                myownbackcolourOption.innerText = myownbackcolourKeys[i];
                myownbackcolourOption.value = myownbackcolourKeys[i];
                myownbackcolour.appendChild(myownbackcolourOption);
            };

            var myheartbackcolourKeys = Object.keys(myheartbackJson["[None]"]);
            for (var i = 0; i < myheartbackcolourKeys.length; i++) {
                myheartbackcolourOption = document.createElement("option");
                myheartbackcolourOption.innerText = myheartbackcolourKeys[i];
                myheartbackcolourOption.value = myheartbackcolourKeys[i];
                myheartbackcolour.appendChild(myheartbackcolourOption);
            };

            //pre-assign custom personality values if personality is set to that custom
            if (personalityName === "My Own") {
                if (customfront){
                    myownfront.value = customfront;
                }
                if (customfrontcolour) {
                    myownfrontcolour.value = customfrontcolour;
                }
                if (customback) {
                    myownback.value = customback;
                }
                if (custombackcolour) {
                    myownbackcolour.value = custombackcolour;
                }
            }
            else if (personalityName === "My Heart") {
                if (customfront) {
                    myheartfront.value = customfront;
                }
                if (customfrontcolour) {
                    myheartfrontcolour.value = customfrontcolour;
                }
                if (customback) {
                    myheartback.value = customback;
                }
                if (custombackcolour) {
                    myheartbackcolour.value = custombackcolour;
                }
            }

            //create option tags for backgrounds
            var cavebgOption;
            for (var i = 0; i < cavebgKeys.length; i++) {
                cavebgOption = document.createElement("option");
                cavebgOption.innerText = cavebgKeys[i];
                cavebgOption.value = cavebgKeys[i];
                cavebg.appendChild(cavebgOption);
            };
            if (bgSelection) {
                cavebg.value = bgSelection;
            }

            //create option tags for floors
            var cavefloorOption;
            for (var i = 0; i < cavefloorKeys.length; i++) {
                cavefloorOption = document.createElement("option");
                cavefloorOption.innerText = cavefloorKeys[i];
                cavefloorOption.value = cavefloorKeys[i];
                cavefloor.appendChild(cavefloorOption);
            };
            if (floorSelection){
                cavefloor.value = floorSelection;
            }

            initializeGenderButtons();
            
            //if gender param exists, update gender
            var genderParam = new URLSearchParams(location.search).get('gender');
            if (genderParam !== null) {
                gender = genderParam;
                switch (gender) {
                    case "m":
                        {
                            maleButton.checked = true;
                            break;
                        }
                    case "f":
                        {
                            femaleButton.checked = true;
                            break;
                        }
                    case "n":
                        {
                            neutralButton.checked = true;
                            break;
                        }
                    default:
                        {
                            maleButton.checked = true;
                        }
                }
            }

            initializeStageButtons();
            changeDragonSprite();
            if (bgSelection){
                updateBackgroundUrl();
            };
            if (floorSelection) {
                updateFloorUrl();
            };
            //(okay, so we're gonna put a tiny timeout here for aura url params to work)
                //(because Spine is being stupid for some reason)
            setTimeout(() => {
                updatePersonalityUrl();
            });
        }
        
        function setGender(genderValue){
            gender = genderValue;
            changeDragonSprite();
        }

        function setStage(stageValue){
            stage = stageValue;
            changeDragonSprite();
        }
        
        function setanimState(animationValue){
            animState = animationValue;
            changeDragonSprite();
        }
        
        function setbgState(bgValue) {
            bgState = bgValue;
            updateBackgroundUrl();
        }
        
        function setfloorState(floorValue) {
            floorState = floorValue;
            updateFloorUrl();
        }

        function setbrightness(brightnessValue) {
            brightness = brightnessValue;
            document.getElementById("Background").style.filter = `brightness(${brightnessValue})`;
        }

        
        function updateSpecies(){
            //if new species, clear form options and append again
            if (speciesName !== species.value){
                speciesName = species.value;
                stage = "adult";
                adultButton.checked = true;
                form.innerHTML = "";
                var formKeys = Object.keys(speciesJson[speciesName].stage[stage].forms);
                formKeys = formKeys.sort();
                
                for (var i = 0; i < formKeys.length; i++){
                    formOption = document.createElement("option");
                        formOption.innerText = speciesJson[speciesName].stage[stage].forms[formKeys[i]].formDisplay;						
                    formOption.value = formKeys[i];
                    form.appendChild(formOption);
                }
                formNumber = "01";
                initializeGenderButtons();
                initializeStageButtons();
            }
            changeDragonSprite();
        }
        
        function updateForm(){
            formNumber = form.value;
            stage = "adult";
            adultButton.checked = true;
            initializeGenderButtons();
            initializeStageButtons();
            changeDragonSprite();
        }

        //enable only the valid stage buttons
        function initializeStageButtons() {
            //disable all non-adult buttons
            hatchButton.disabled = true;
            hatchButton.setAttribute('aria-disabled', true);
            hatchlingButton.disabled = true;
            hatchlingButton.setAttribute('aria-disabled', true);
            essenceButton.disabled = true;
            essenceButton.setAttribute('aria-disabled', true);
            prismButton.disabled = true;
            prismButton.setAttribute('aria-disabled', true);

            //add disabled class to hatch, hatchling, essence, and prism labels
            hatchLabel.classList.add("disabledButton");
            hatchLabel.setAttribute('aria-disabled', true);
            hatchlingLabel.classList.add("disabledButton");
            hatchlingLabel.setAttribute('aria-disabled', true);
            essenceLabel.classList.add("disabledButton");
            essenceLabel.setAttribute('aria-disabled', true);
            prismLabel.classList.add("disabledButton");
            prismLabel.setAttribute('aria-disabled', true);

            //enable valid buttons
            if (speciesJson[speciesName].stage['hatch'] !== undefined && speciesJson[speciesName].stage['hatch'].forms[formNumber] !== undefined){
                hatchButton.disabled = false;
                hatchButton.setAttribute('aria-disabled', false);
                hatchLabel.classList.remove("disabledButton");
                hatchLabel.setAttribute('aria-disabled', false);
            }
            if (speciesJson[speciesName].stage['hatchling'] !== undefined && speciesJson[speciesName].stage['hatchling'].forms[formNumber] !== undefined) {
                hatchlingButton.disabled = false;
                hatchlingButton.setAttribute('aria-disabled', false);
                hatchlingLabel.classList.remove("disabledButton");
                hatchlingLabel.setAttribute('aria-disabled', false);
            }
            if (speciesJson[speciesName].stage['essence'] !== undefined && speciesJson[speciesName].stage['essence'].forms[formNumber] !== undefined) {
                essenceButton.disabled = false;
                essenceButton.setAttribute('aria-disabled', false);
                essenceLabel.classList.remove("disabledButton");
                essenceLabel.setAttribute('aria-disabled', false);
            }
            if (speciesJson[speciesName].stage['prism'] !== undefined && speciesJson[speciesName].stage['prism'].forms[formNumber] !== undefined) {
                prismButton.disabled = false;
                prismButton.setAttribute('aria-disabled', false);
                prismLabel.classList.remove("disabledButton");
                prismLabel.setAttribute('aria-disabled', false);
            }


            switch (stage){
                case 'adult': {
                    adultButton.checked = true;
                    adultButton.setAttribute('aria-disabled', false);
                    adultLabel.setAttribute('aria-disabled', false);
                    break;
                }
                case 'essence': {
                    essenceButton.checked = true;
                    essenceButton.setAttribute('aria-disabled', false);
                    essenceLabel.setAttribute('aria-disabled', false);
                    break;
                }
                case 'prism': {
                    prismButton.checked = true;
                    prismButton.setAttribute('aria-disabled', false);
                    prismLabel.setAttribute('aria-disabled', false);
                    break;
                }
                case 'hatchling': {
                    hatchlingButton.checked = true;
                    hatchlingButton.setAttribute('aria-disabled', false);
                    hatchlingLabel.setAttribute('aria-disabled', false);
                    break;
                }
                case 'hatch': {
                    hatchButton.checked = true;
                    hatchButton.setAttribute('aria-disabled', false);
                    hatchLabel.setAttribute('aria-disabled', false);
                    break;
                }
                default: {
                    adultButton.checked = true;
                    adultButton.setAttribute('aria-disabled', false);
                    adultLabel.setAttribute('aria-disabled', false);
                }
            }
        }
        
        //enable only the valid gender buttons
        function initializeGenderButtons(){
            //disable all 3 buttons
            maleButton.disabled = true;
            maleButton.setAttribute('aria-disabled', true);
            femaleButton.disabled = true;
            femaleButton.setAttribute('aria-disabled', true);
            neutralButton.disabled = true;
            neutralButton.setAttribute('aria-disabled', true);
            
            //add disabled class to all 3 labels
            maleLabel.classList.add("disabledButton");
            maleLabel.setAttribute('aria-disabled', true);
            femaleLabel.classList.add("disabledButton");
            femaleLabel.setAttribute('aria-disabled', true);
            neutralLabel.classList.add("disabledButton");
            neutralLabel.setAttribute('aria-disabled', true);
            
            //get keys for current species' genders
            var genderKeys = Object.keys(speciesJson[speciesName].stage[stage].forms[formNumber].genders);

            

            //enable all valid keys
            for (var i = 0; i < genderKeys.length; i++){
                switch(genderKeys[i]){
                    case "m":
                    {
                        maleButton.disabled = false;
                        maleLabel.classList.remove("disabledButton");
                        maleButton.checked = true;
                        maleButton.setAttribute('aria-disabled', false);
                        maleLabel.setAttribute('aria-disabled', false);
                        gender = "m";
                        break;
                    }
                    case "f":
                    {
                        femaleButton.disabled = false;
                        femaleLabel.classList.remove("disabledButton");
                        femaleButton.checked = true;
                        femaleButton.setAttribute('aria-disabled', false);
                        femaleLabel.setAttribute('aria-disabled', false);
                        gender = "f";
                        break;
                    }
                    case "n":
                    {
                        neutralButton.disabled = false;
                        neutralLabel.classList.remove("disabledButton");
                        neutralButton.checked = true;
                        neutralButton.setAttribute('aria-disabled', false);
                        neutralLabel.setAttribute('aria-disabled', false);
                        gender = "n";
                        break;
                    }
                    default:
                    {
                        maleButton.disabled = false;
                        maleLabel.classList.remove("disabledButton");
                        maleButton.checked = true;
                        maleButton.setAttribute('aria-disabled', false);
                        maleLabel.setAttribute('aria-disabled', false);
                        gender = "m";
                    }
                }
            }
        }

        //load new dragon when changed
        function changeDragonSprite(){
            //get dragon url parts
            formNumber = form.value;
            var colorName = speciesJson[speciesName].stage[stage].forms[formNumber].genders[gender].color;

            //construct url
            var url = "";
            //is it undead? or is it dead dead?
            if (formNumber.indexOf("undead") !== -1){
                var undeadres = speciesJson[speciesName].stage[stage].forms[formNumber].genders[gender].undeadres;
                url = "https://vega-spica.github.io/Personality-Sneak-Peek-Expanded/res/spine/character/dragon/" + "undead" + "/" + "undead" +"_" + undeadres + "/" + "undead" + "_" + undeadres;
            }
            //no idea why they put these in a separate folder but sure i guess??
            else if (stage.indexOf("essence") !== -1) {
                url = "https://vega-spica.github.io/Personality-Sneak-Peek-Expanded/res/spine/character/dragon/essence/" + speciesName + "_" + formNumber + "_" + gender + "_" + stage + "_" + colorName + "/" + speciesName + "_" + formNumber + "_" + gender + "_" + stage + "_" + colorName;
            }
            else {
                url = "https://vega-spica.github.io/Personality-Sneak-Peek-Expanded/res/spine/character/dragon/" + speciesName + "_" + formNumber +"_" + gender + "_" + stage + "_" + colorName + "/" + speciesName + "_" + formNumber +"_" + gender + "_" + stage + "_" + colorName;
            }

            //print url to console log (i'm hopeless and need this here for debugging, don't judge me)
            //console.log(url);

    const dragonCanvasElem = document.getElementById("dragonCanvas");
    const dragonImageElem = document.getElementById("dragon-image");
            
            //load new dragon to canvas
            if (url.includes(".png")) {
                //remake url for png
                    //because Frame.
                url = "https://vega-spica.github.io/Personality-Sneak-Peek-Expanded/res/spine/character/dragon/" + speciesName + "_" + formNumber + "_" + gender + "_" + stage + colorName;
                
                //hide canvas
                dragonCanvasElem.style.display = "none";
                
                //load image
                dragonImageElem.style.display = "inline-block";
                dragonImageElem.src = url;
            } else {
                //hide image
                dragonImageElem.style.display = "none";
        
        // disposing of old resource before assigning new one to avoid performance issue
        if (canvases.dragon) {
        canvases.dragon.dispose();
        }

                //show canvas
        dragonCanvasElem.style.display = "inline-block";
        canvases.dragon = new spine.SpineCanvas(dragonCanvasElem, {
        app: new SpineObject(url, animState)
        });
            }				
        }

        //load new personality when changed
        function updatePersonalityUrl() {
            document.getElementById("myownselect").style.display = "none";
            document.getElementById("myheartselect").style.display = "none";
    // disposing of old resources before assigning new one to avoid performance issue
    if (canvases.backAura) { canvases.backAura.dispose(); }
    if (canvases.frontAura) { canvases.frontAura.dispose(); }

            personalityName = personality.value;
            //this bit is only here because highbrow decided that some auras are °˳⁠˚⁠∘⁠✧special✧∘⁠˚⁠˳⁠° now!!
                //edit: and of course, they weren't special enough, so they added custom ones that are °˳⁠˚⁠∘⁠✧super special✧∘⁠˚⁠˳⁠°!! 
            if(personalityName === "My Own") {
                document.getElementById("myownselect").style.display = "block";
                var myownfrontSelection = myownfrontJson[myownfront.value];
                var myownbackSelection = myownbackJson[myownback.value];
                canvases.backAura = new spine.SpineCanvas(document.getElementById("Auraback"), {
                    app: new SpineObject("https://vega-spica.github.io/Personality-Sneak-Peek-Expanded/res/spine/aura_each/aura_blissfull/aura_blissfull", myownbackSelection[myownbackcolour.value])
                });
                canvases.frontAura = new spine.SpineCanvas(document.getElementById("Aurafront"), {
                    app: new SpineObject("https://vega-spica.github.io/Personality-Sneak-Peek-Expanded/res/spine/aura_each/aura_blissfull/aura_blissfull", myownfrontSelection[myownfrontcolour.value])
                });
            }
            else if (personalityName === "My Heart") {
                document.getElementById("myheartselect").style.display = "block";
                var myheartfrontSelection = myheartfrontJson[myheartfront.value];
                var myheartbackSelection = myheartbackJson[myheartback.value];
                canvases.backAura = new spine.SpineCanvas(document.getElementById("Auraback"), {
                    app: new SpineObject("https://vega-spica.github.io/Personality-Sneak-Peek-Expanded/res/spine/aura_each/aura_myheart/aura_myheart", myheartbackSelection[myheartbackcolour.value])
                });
                canvases.frontAura = new spine.SpineCanvas(document.getElementById("Aurafront"), {
                    app: new SpineObject("https://vega-spica.github.io/Personality-Sneak-Peek-Expanded/res/spine/aura_each/aura_myheart/aura_myheart", myheartfrontSelection[myheartfrontcolour.value])
                });
            }
            else if (personalityJson[personalityName].each !== undefined) {
                canvases.backAura = new spine.SpineCanvas(document.getElementById("Auraback"), {
                    app: new SpineObject(`https://vega-spica.github.io/Personality-Sneak-Peek-Expanded/res/spine/aura_each/${personalityJson[personalityName].each}/${personalityJson[personalityName].each}`, personalityJson[personalityName].back)
                });
                canvases.frontAura = new spine.SpineCanvas(document.getElementById("Aurafront"), {
                    app: new SpineObject(`https://vega-spica.github.io/Personality-Sneak-Peek-Expanded/res/spine/aura_each/${personalityJson[personalityName].each}/${personalityJson[personalityName].each}`, personalityJson[personalityName].front)
                });
            }
            //of course, we love all the rest of them. but they're not special.
            else {
                canvases.backAura = new spine.SpineCanvas(document.getElementById("Auraback"), {
                    app: new SpineObject("https://vega-spica.github.io/Personality-Sneak-Peek-Expanded/res/spine/aura/aura_back/aura_back", personalityJson[personalityName].back)
                });
                canvases.frontAura = new spine.SpineCanvas(document.getElementById("Aurafront"), {
                    app: new SpineObject("https://vega-spica.github.io/Personality-Sneak-Peek-Expanded/res/spine/aura/aura_front/aura_front", personalityJson[personalityName].front)
                });
            }
        }

        //well, you wanted backgrounds, so...
        function updateBackgroundUrl() {
           //get background url parts
            bgSelection = cavebgJson[cavebg.value].res;

            if (canvases.background) {
                canvases.background.dispose();
            }

            //construct url
            var bgurl = "https://vega-spica.github.io/Personality-Sneak-Peek-Expanded/res/spine/cavedeco/" + bgSelection;
            //yes, the "none" option is just an invisible aura...
                //don't question it
            if (bgSelection === "none") {
                canvases.background = new spine.SpineCanvas(document.getElementById("Background"), {
                    app: new SpineObject("https://vega-spica.github.io/Personality-Sneak-Peek-Expanded/res/spine/aura/aura_back/aura_back", "")
                });
            }
            else {
                canvases.background = new spine.SpineCanvas(document.getElementById("Background"), {
                    app: new SpineObject(bgurl, bgState)
                });
            }
        }

        function updateFloorUrl() {
                //get background url parts
                floorSelection = cavefloorJson[cavefloor.value].res;

                if (canvases.floor) {
                    canvases.floor.dispose();
                }

                //construct url
                var floorurl = "https://vega-spica.github.io/Personality-Sneak-Peek-Expanded/res/spine/cavedeco/" + floorSelection;
                // invisible aura is best aura.
                if (floorSelection === "none") {
                    canvases.floor = new spine.SpineCanvas(document.getElementById("Floor"), {
                        app: new SpineObject("https://vega-spica.github.io/Personality-Sneak-Peek-Expanded/res/spine/aura/aura_back/aura_back", "")
                    });
                }
                else {
                    canvases.floor = new spine.SpineCanvas(document.getElementById("Floor"), {
                        app: new SpineObject(floorurl, floorState)
                    });
                }
            }

        function copySharelink() {
                // initialize shareLink with required values
                var shareLink = `https://vega-spica.github.io/Personality-Sneak-Peek-Expanded/?species=${speciesName}&form=${formNumber}&gender=${gender}&stage=${stage}`

                //add optional values
                if (personalityName !== null){
                    shareLink = shareLink + `&personality=${personalityName}`;
                }
                if (cavebg.value !== '[None]') {
                    shareLink = shareLink + `&bg=${cavebg.value}`;
                }
                if (cavefloor.value !== '[None]') {
                    shareLink = shareLink + `&floor=${cavefloor.value}`;
                }
                if (personalityName === "My Own"){
                    shareLink = shareLink + `&front=${myownfront.value}&back=${myownback.value}&frontcolour=${myownfrontcolour.value}&backcolour=${myownbackcolour.value}`;
                }
                else if (personalityName === "My Heart"){
                    shareLink = shareLink + `&front=${myheartfront.value}&back=${myheartback.value}&frontcolour=${myheartfrontcolour.value}&backcolour=${myheartbackcolour.value}`;
                }

                // copy sharelink
                shareLink = shareLink.replace(/ /g,"%20");
                shareLink = shareLink.replace(/\[/g, "%5B");
                shareLink = shareLink.replace(/\]/g, "%5D");
                navigator.clipboard.writeText(shareLink);

                // alert for copied sharelink
                var alert = document.getElementById("buttonAlert");
                alert.style.display = "block";

                setTimeout(()=> {
                    alert.style.display = "none";
                }, 2500);
            }

    </script>
</head>

<!--super-cool, chocolatey fudge-coated page content. now comes *with* the wrapper, thankfully.-->
<div class="wrapper">
    <div class="left-container">

        <!--selection for auras where entries are appended-->
        <b>Personality</b>&nbsp;
        <select id="personality" name="personality" onchange="updatePersonalityUrl();">
        </select>
    
        <div id="myownselect">
            <br>
            <!--selection for My Own fronts where entries are appended-->
            <b>Front</b>&nbsp;
            <select id="myownfront" name="myownfront" onchange="updatePersonalityUrl();">
            </select>
    
            <!--selection for My Own front colours where entries are appended-->
            <select id="myownfrontcolour" name="myownfrontcolour" onchange="updatePersonalityUrl();">
            </select>
            <br><br>
    
            <!--selection for My Own backs where entries are appended-->
            <b>Back</b>&nbsp;
            <select id="myownback" name="myownback" onchange="updatePersonalityUrl();">
            </select>
    
            <!--selection for My Own back colours where entries are appended-->
            <select id="myownbackcolour" name="myownbackcolour" onchange="updatePersonalityUrl();">
            </select>
        </div>

        <div id="myheartselect">
            <br>
            <!--selection for My Heart fronts where entries are appended-->
            <b>Front</b>&nbsp;
            <select id="myheartfront" name="myheartfront" onchange="updatePersonalityUrl();">
            </select>
        
            <!--selection for My Heart front colours where entries are appended-->
            <select id="myheartfrontcolour" name="myheartfrontcolour" onchange="updatePersonalityUrl();">
            </select>
            <br><br>
        
            <!--selection for My Heart backs where entries are appended-->
            <b>Back</b>&nbsp;
            <select id="myheartback" name="myheartback" onchange="updatePersonalityUrl();">
            </select>
        
            <!--selection for My Heart back colours where entries are appended-->
            <select id="myheartbackcolour" name="myheartbackcolour" onchange="updatePersonalityUrl();">
            </select>
        </div>
        <br><br>
    
        <!--selection for backgrounds where entries are appended-->
        <b>Background</b>&nbsp;
        <select id="cavebg" name="cavebg" onchange="updateBackgroundUrl();">
        </select>
        <br>
        <div id="bgRadios" class="bgRadios">
            <input type="radio" name="bg" value="idle" id="bgidle" onchange="setbgState(this.value)" checked />
            <label for="bgidle" id="bgidleLabel">Idle</label>
            &nbsp;
            <input type="radio" name="bg" value="" id="bgstop" onchange="setbgState(this.value)" />
            <label for="bgstop" id="bgstopLabel">Stop</label>
            <br>
            <input type="radio" name="brightness" value="1" id="bright" onchange="setbrightness(this.value)" checked />
            <label for="bright" id="brightLabel">Bright</label>
            &nbsp;
            <input type="radio" name="brightness" value="0.5" id="dark" onchange="setbrightness(this.value)" />
            <label for="dark" id="darkLabel">Dark</label>           
        </div>
        <br>
    
        <!--selection for floors where entries are appended-->
        <b>Floor</b>&nbsp;
        <select id="cavefloor" name="cavefloor" onchange="updateFloorUrl();">
        </select>
        <br>
        <div id="floorRadios" class="floorRadios">
            <input type="radio" name="floor" value="idle" id="flooridle" onchange="setfloorState(this.value)" checked />
            <label for="flooridle" id="flooridleLabel">Idle</label>
            &nbsp;
            <input type="radio" name="floor" value="" id="floorstop" onchange="setfloorState(this.value)" />
            <label for="floorstop" id="floorstopLabel">Stop</label>
        </div>
        <br>
        <input type="image" onclick="copySharelink()" src="./res/img/link_0202.png" width="40px" alt="Copy Sharelink"></input>
        <br>
        <p id="buttonAlert">Copied!</p>
    </div>

    <div class="center-container">
        <!--is this really a header? or is it all just an illusion..?-->
        <div class="header">
            <img src="./res/img/logo.png" width="180px" alt="Dragon Village Collection">
            <!-- </a> -->
            <br><b>Personality Sneak-Peek (Expanded)</b>
        </div><br>

        <div class="grid-container">
        
            <div class="grid-item">
                <canvas id="dragonCanvas" class="spineCanvas dragonCanvas"></canvas>
                <canvas id="Auraback" class="spineCanvas auraBackCanvas"></canvas>
                <canvas id="Aurafront" class="spineCanvas auraFrontCanvas"></canvas>
                <canvas id="Background" class="spineCanvas backgroundCanvas"></canvas>
                <canvas id="Floor" class="spineCanvas floorCanvas"></canvas>
                
            </div>
            <img id="dragon-image">
        </div>
        
        <!--initial blank back aura canvas is loaded on page open-->
        <script type="text/javascript">
            let loadSpineAuraBackAura = function() { 
                canvases.backAura = new spine.SpineCanvas(document.getElementById("Auraback"), {
                    app: new SpineObject("https://vega-spica.github.io/Personality-Sneak-Peek-Expanded/res/spine/aura/aura_back/aura_back", "")
                })
            }
            window.addEventListener("load", loadSpineAuraBackAura);
        </script>

        <!--initial blank front aura canvas is loaded on page open-->
        <script type="text/javascript"> 
            let loadSpineAuraFrontAura = function() {
                canvases.frontAura = new spine.SpineCanvas(document.getElementById("Aurafront"), {
                    app: new SpineObject("https://vega-spica.github.io/Personality-Sneak-Peek-Expanded/res/spine/aura/aura_front/aura_front", "")
                })
            }
            window.addEventListener("load", loadSpineAuraFrontAura);
        </script>

        <div class="footer">
            <!--just a horizontal line. nothing to see here.-->
            <hr size=1>
            <!--i don't own DVC's assets; please don't sue me.-->
            Desktop view is recommended. Positioning can be adjusted by zooming in or out.<br>
            Gender/Evolution icons can be clicked, as well as screen-read for accessibility.<br>
            Dragon Village Collection assets and all Dragon Village characters ©highbrow Corp<br>
            <a href="https://github.com/vega-spica/Personality-Sneak-Peek-Expanded">Github repository</a> | 한국어: <a href=https://ctcdra.github.io/Personality-Sneak-Peek-Expanded_KRtranslate>시토콘드리아</a> | <a href="https://discord.gg/dvc">Official DVC Discord</a><br>
            If you enjoyed using this tool, please consider contributing to the <a href=https://dragon-village-collection.fandom.com/wiki/Dragon_Village_Collection_Wiki>DVC Fandom Wiki</a>.
        </div>
        </div>

    <div class="right-container">
        <div class="species-container">
            <!--selection for species where entries are appended-->
            <b>Species</b>&nbsp;
            <div class="dropdown">
                <input type="text" class="search-box" id="search" placeholder="Search..." onkeyup="filterFunction()"
                    onfocus="showAll()">
                <div class="dropdown-content" id="dropdown"></div>
            </div>
            
            <select id="species" name="species" style="display: none;" onchange="updateSpecies();">
            </select>
            <br><br>

            <!--selection for forms where entries are appended-->
            <b>Form</b>&nbsp;
            <select id="form" name="form" onchange="updateForm();">
            </select>

            <script>
                //okay, okay, i get it. you want a searchbar.
                    //you get ONE searchbar.
                function populateDropdown() {
                    let select = document.getElementById("species");
                    let dropdown = document.getElementById("dropdown");
                    dropdown.innerHTML = ""; // wipe existing options

                    for (let option of select.options) {
                        let div = document.createElement("div");
                        div.textContent = option.text;
                        div.setAttribute("data-value", option.value);
                        div.onclick = function () {
                            document.getElementById("search").value = this.textContent;
                            document.getElementById("species").value = this.getAttribute("data-value");
                            document.getElementById("dropdown").style.display = "none";
                            updateSpecies();
                        };
                        dropdown.appendChild(div);
                    }
                }

                // show all options on focus 
                    //"onclick" was not cooperating, so we fired them.
                function showAll() {
                    let dropdown = document.getElementById("dropdown");
                    let items = dropdown.getElementsByTagName("div");
                    dropdown.style.display = "block";

                    for (let i = 0; i < items.length; i++) {
                        items[i].style.display = "block";
                    }
                }

                // filter options
                function filterFunction() {
                    let input = document.getElementById("search");
                    let filter = input.value.toLowerCase();
                    let dropdown = document.getElementById("dropdown");
                    let items = dropdown.getElementsByTagName("div");
                    dropdown.style.display = filter ? "block" : "none";

                    for (let i = 0; i < items.length; i++) {
                        let txtValue = items[i].textContent || items[i].innerText;
                        items[i].style.display = txtValue.toLowerCase().includes(filter) ? "block" : "none";
                    }
                }

                // close dropdown on outside click
                document.addEventListener("click", function (event) {
                    let dropdown = document.getElementById("dropdown");
                    let searchBox = document.getElementById("search");
                    if (!searchBox.contains(event.target) && !dropdown.contains(event.target)) {
                        dropdown.style.display = "none";
                    }
                });

                // observe species changes and update dropdown
                function observeSpeciesChanges() {
                    let speciesSelect = document.getElementById("species");

                    new MutationObserver(() => {
                        populateDropdown(); // re-populate dropdown when new species are added
                    }).observe(speciesSelect, { childList: true });
                }

                // initialize dropdown list, observe species changes
                populateDropdown();
                observeSpeciesChanges();
            </script>
        </div>
        <br><br>

        <!--who needs text for radio buttons, anyways?-->
        <div id="genderRadios" class="genderRadios">
            <input type="radio" name="gender" value="m" id="male" onchange="setGender(this.value)" checked />
            <label for="male" id="maleLabel" aria-disabled="false">
                <img src="./res/img/gender_m_0201.png" alt="male selection">
            </label>
            <input type="radio" name="gender" value="f" id="female" onchange="setGender(this.value)" />
            <label for="female" id="femaleLabel" aria-disabled="false">
                <img src="./res/img/gender_f_0201.png" alt="female selection">
            </label>
            <input type="radio" name="gender" value="n" id="neutral" onchange="setGender(this.value)">
            <label for="neutral" id="neutralLabel" aria-disabled="false">
                <img src="./res/img/gender_n_0201.png" alt="neutral selection">
            </label>
        </div>
        <br>

        <div id="stageRadios" class="stageRadios">
            <input type="radio" name="stage" value="hatch" id="hatch" onchange="setStage(this.value)" />
            <label for="hatch" id="hatchLabel" aria-disabled="false">
                <img src="./res/img/stage_hatch.png" alt="hatch selection">
            </label>
            <input type="radio" name="stage" value="hatchling" id="hatchling" onchange="setStage(this.value)" />
            <label for="hatchling" id="hatchlingLabel" aria-disabled="false">
                <img src="./res/img/stage_hatchling.png" alt="hatchling selection">
            </label>
            <input type="radio" name="stage" value="adult" id="adult" onchange="setStage(this.value)" checked>
            <label for="adult" id="adultLabel" aria-disabled="false">
                <img src="./res/img/stage_adult.png" alt="adult selection">
            </label>
            <br>
            <input type="radio" name="stage" value="essence" id="essence" onchange="setStage(this.value)" />
            <label for="essence" id="essenceLabel" aria-disabled="false">
                <img src="./res/img/stage_essence.png" alt="essence selection">
            </label>
            <input type="radio" name="stage" value="prism" id="prism" onchange="setStage(this.value)" />
            <label for="prism" id="prismLabel" aria-disabled="false">
                <img src="./res/img/stage_prism.png" alt="prism selection">
            </label>
        </div>
        <br>

        <!-- ...okay fine, these ones can have text. -->
        <div id="animRadios" class="animRadios">
            <input type="radio" name="animation" value="idle" id="idle" onchange="setanimState(this.value)" checked />
            <label for="idle" id="idleLabel">Idle</label>
            <br>
            <input type="radio" name="animation" value="move" id="move" onchange="setanimState(this.value)" />
            <label for="move" id="moveLabel">Moving</label>
            <br>
            <input type="radio" name="animation" value="holding" id="holding" onchange="setanimState(this.value)">
            <label for="holding" id="holdingLabel">Holding</label>
            <br>
            <input type="radio" name="animation" value="touch" id="touch" onchange="setanimState(this.value)">
            <label for="touch" id="touchLabel">Touch</label>
            <br>
            <input type="radio" name="animation" value="" id="none" onchange="setanimState(this.value)">
            <label for="none" id="touchLabel">None</label>
        </div>
    </div>
</div>
	